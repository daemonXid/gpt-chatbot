<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ config.title }}</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        color: white;
        text-align: center;
      }

      .header h1 {
        font-size: 2em;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
      }

      .nav-buttons {
        margin-top: 15px;
      }

      .btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        margin: 0 10px;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.3);
        text-decoration: none;
        color: white;
      }

      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 1600px; /* 800pxì—ì„œ 1600pxë¡œ 2ë°° í™•ì¥ */
        margin: 20px auto;
        padding: 0 20px;
      }

      .chat-messages {
        flex: 1;
        background: white;
        border-radius: 20px 20px 0 0;
        padding: 20px;
        overflow-y: auto;
        min-height: 400px;
        max-height: 500px;
      }

      .message {
        margin-bottom: 20px;
        display: flex;
        align-items: flex-start;
      }

      .user-message {
        justify-content: flex-end;
      }

      .bot-message {
        justify-content: flex-start;
      }

      .message-bubble {
        max-width: 80%;
        padding: 15px 20px;
        border-radius: 20px;
        line-height: 1.5;
      }

      .user-message .message-bubble {
        background: #667eea;
        color: white;
        border-bottom-right-radius: 5px;
      }

      .bot-message .message-bubble {
        background: #f1f1f1;
        color: #333;
        border-bottom-left-radius: 5px;
      }

      .chat-input-container {
        background: white;
        padding: 25px 30px; /* íŒ¨ë”© ì¦ê°€ */
        border-radius: 0 0 20px 20px;
        display: flex;
        gap: 15px; /* ê°„ê²© ì¦ê°€ */
        align-items: flex-end; /* í•˜ë‹¨ ì •ë ¬ */
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); /* ìƒë‹¨ ê·¸ë¦¼ì */
      }

      .chat-input {
        flex: 1;
        padding: 20px 25px; /* íŒ¨ë”© ì¦ê°€ë¡œ ë” ë„“ì€ ëŠë‚Œ */
        border: 2px solid #e1e5e9; /* í…Œë‘ë¦¬ ê°•í™” */
        border-radius: 30px; /* ë” ë‘¥ê¸€ê²Œ */
        font-size: 18px; /* í°íŠ¸ í¬ê¸° ì¦ê°€ */
        outline: none;
        resize: none;
        min-height: 60px; /* ë†’ì´ë„ ì•½ê°„ ì¦ê°€ */
        max-height: 200px; /* ìµœëŒ€ ë†’ì´ ì„¤ì • */
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.5;
        transition: all 0.3s ease;
      }

      .chat-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
      }

      .send-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 18px 30px; /* íŒ¨ë”© ì¦ê°€ */
        border-radius: 30px; /* ë” ë‘¥ê¸€ê²Œ */
        cursor: pointer;
        font-size: 18px; /* í°íŠ¸ í¬ê¸° ì¦ê°€ */
        font-weight: 600; /* í°íŠ¸ êµµê²Œ */
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        min-width: 120px; /* ìµœì†Œ ë„ˆë¹„ ì„¤ì • */
      }

      .send-btn:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b4fa0 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .send-btn:active {
        transform: translateY(0px);
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
      }

      .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .loading {
        display: none;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .loading-dots {
        display: flex;
        gap: 5px;
      }

      .loading-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #667eea;
        animation: loading 1.4s ease-in-out infinite both;
      }

      .loading-dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .loading-dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes loading {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      .status-info {
        text-align: center;
        color: #666;
        font-size: 0.9em;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 10px;
        margin-bottom: 10px;
      }

      @media (max-width: 768px) {
        .chat-container {
          margin: 10px;
          padding: 0 10px;
          max-width: 100%; /* ëª¨ë°”ì¼ì—ì„œëŠ” ì „ì²´ ë„ˆë¹„ ì‚¬ìš© */
        }

        .message-bubble {
          max-width: 90%;
        }

        .header h1 {
          font-size: 1.5em;
        }

        .chat-input {
          font-size: 16px; /* ëª¨ë°”ì¼ì—ì„œ ì¤Œ ë°©ì§€ */
          min-height: 50px;
          padding: 15px 20px;
        }

        .send-btn {
          padding: 15px 25px;
          font-size: 16px;
          min-width: 100px;
        }

        .chat-input-container {
          padding: 20px 15px;
          gap: 10px;
        }
      }

      /* íƒœë¸”ë¦¿ ì‚¬ì´ì¦ˆ ê°œì„  */
      @media (min-width: 769px) and (max-width: 1200px) {
        .chat-container {
          max-width: 1200px; /* íƒœë¸”ë¦¿ì—ì„œëŠ” ì¤‘ê°„ í¬ê¸° */
        }
      }

      /* ëŒ€í˜• í™”ë©´ ìµœì í™” */
      @media (min-width: 1600px) {
        .chat-container {
          max-width: 1800px; /* ëŒ€í˜• í™”ë©´ì—ì„œëŠ” ë”ìš± ë„“ê²Œ */
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>{{ config.title }}</h1>
      <p>{{ config.description }}</p>
      <div class="nav-buttons">
        <a href="/" class="btn">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
        <button onclick="resetChat()" class="btn">ğŸ”„ ëŒ€í™” ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="chat-container">
      <div class="chat-messages" id="chatMessages">
        {% if bot_type == 'chat' %}
        <div class="status-info" id="statusInfo">ëŒ€í™” íšŸìˆ˜: 0/10</div>
        {% endif %}
        <div class="message bot-message">
          <div class="message-bubble">
            ì•ˆë…•í•˜ì„¸ìš”! {{ config.title }}ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
          </div>
        </div>
      </div>

      <div class="loading" id="loading">
        <div class="loading-dots">
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
        </div>
      </div>

      <div class="chat-input-container">
        <textarea
          id="messageInput"
          class="chat-input"
          placeholder="{{ config.placeholder }}"
          rows="1"
        ></textarea>
        <button onclick="sendMessage()" class="send-btn" id="sendBtn">
          ì „ì†¡
        </button>
      </div>
    </div>

    <script>
      const botType = "{{ bot_type }}";
      let isLoading = false;

      // ì—”í„°í‚¤ë¡œ ì „ì†¡
      document
        .getElementById("messageInput")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

      // í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ í¬ê¸° ì¡°ì ˆ (ê°œì„ ëœ ë²„ì „)
      document
        .getElementById("messageInput")
        .addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 200) + "px"; // ìµœëŒ€ ë†’ì´ ì¦ê°€

          // í…ìŠ¤íŠ¸ ì˜ì—­ ìŠ¤í¬ë¡¤ ìµœí•˜ë‹¨ìœ¼ë¡œ ìœ ì§€
          this.scrollTop = this.scrollHeight;
        });

      function addMessage(content, isUser) {
        const messagesContainer = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${
          isUser ? "user-message" : "bot-message"
        }`;

        const bubbleDiv = document.createElement("div");
        bubbleDiv.className = "message-bubble";
        bubbleDiv.innerHTML = content.replace(/\n/g, "<br>");

        messageDiv.appendChild(bubbleDiv);
        messagesContainer.appendChild(messageDiv);

        // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function showLoading(show) {
        const loadingDiv = document.getElementById("loading");
        const sendBtn = document.getElementById("sendBtn");
        const messageInput = document.getElementById("messageInput");

        if (show) {
          loadingDiv.style.display = "flex";
          sendBtn.disabled = true;
          messageInput.disabled = true;
          isLoading = true;
        } else {
          loadingDiv.style.display = "none";
          sendBtn.disabled = false;
          messageInput.disabled = false;
          isLoading = false;
        }
      }

      async function sendMessage() {
        if (isLoading) return;

        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value.trim();

        if (!message) return;

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        addMessage(message, true);
        messageInput.value = "";
        messageInput.style.height = "auto";

        // ë¡œë”© í‘œì‹œ
        showLoading(true);

        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              bot_type: botType,
              message: message,
            }),
          });

          const data = await response.json();

          if (data.error) {
            addMessage(`ì˜¤ë¥˜: ${data.error}`, false);
          } else {
            addMessage(data.response, false);

            // 10ì¤„ ì±—ë´‡ì˜ ê²½ìš° í„´ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            if (botType === "chat" && data.turn_count) {
              const statusInfo = document.getElementById("statusInfo");
              if (statusInfo) {
                statusInfo.textContent = `ëŒ€í™” íšŸìˆ˜: ${data.turn_count}`;
              }
            }

            // ëŒ€í™” ì™„ë£Œ ì²´í¬
            if (data.finished) {
              messageInput.disabled = true;
              document.getElementById("sendBtn").disabled = true;
            }
          }
        } catch (error) {
          addMessage(`í†µì‹  ì˜¤ë¥˜: ${error.message}`, false);
        }

        showLoading(false);
      }

      async function resetChat() {
        if (confirm("ëŒ€í™”ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          try {
            await fetch(`/api/reset/${botType}`, {
              method: "POST",
            });

            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            location.reload();
          } catch (error) {
            alert("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        }
      }
    </script>

    <style>
      /* AI í† ë¡  ë´‡ ì „ìš© ìŠ¤íƒ€ì¼ */
      .debate-setup-container {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      }
      .debate-setup-container h2 {
        text-align: center;
        margin-bottom: 20px;
      }
      .debate-setup-container .form-group {
        margin-bottom: 20px;
      }
      .debate-setup-container label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .debate-setup-container .form-control {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        border-radius: 10px;
        border: 1px solid #ccc;
      }
      .debate-setup-container .btn-group {
        display: flex;
        gap: 10px;
        justify-content: center;
      }
      .personas-container {
        display: none; /* ì´ˆê¸°ì— ìˆ¨ê¹€ */
        margin-top: 20px;
        display: none;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
    </style>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const botType = "{{ bot_type }}";
        if (botType === 'debate') {
            const chatContainer = document.querySelector('.chat-container');
            const originalChatMessages = document.getElementById('chatMessages');
            const originalMessageForm = document.querySelector('.chat-input-container');
            let eventSource;

            // 1. ê¸°ì¡´ UI ìˆ¨ê¸°ê¸°
            originalChatMessages.style.display = 'none';
            originalMessageForm.style.display = 'none';

            // 2. ìƒˆë¡œìš´ ì„¤ì • UI ìƒì„±
            const setupContainer = document.createElement('div');
            setupContainer.className = 'debate-setup-container';
            setupContainer.innerHTML = `
                <h2>í† ë¡  ì„¤ì •</h2>
                <div class="form-group">
                    <label for="topicInput">í† ë¡  ì£¼ì œ</label>
                    <input type="text" id="topicInput" class="form-control" placeholder="ì˜ˆ: ì†Œì…œ ë¯¸ë””ì–´ëŠ” ì‚¬íšŒì— ê¸ì •ì ì¸ê°€?">
                </div>
                <div class="btn-group">
                    <button id="generatePersonasBtn" class="send-btn">í˜ë¥´ì†Œë‚˜ ìƒì„±</button>
                </div>
                <div id="loadingSpinner" style="display: none; text-align: center; margin-top: 20px;">í˜ë¥´ì†Œë‚˜ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</div>
                <div id="personasContainer" class="personas-container">
                    <div class="form-group">
                        <label for="persona1Text">ì°¬ì„± ì¸¡ í˜ë¥´ì†Œë‚˜</label>
                        <textarea id="persona1Text" class="form-control" rows="6"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="persona2Text">ë°˜ëŒ€ ì¸¡ í˜ë¥´ì†Œë‚˜</label>
                        <textarea id="persona2Text" class="form-control" rows="6"></textarea>
                    </div>
                </div>
                <div id="debateActions" class="btn-group" style="display: none; margin-top: 20px;">
                    <button id="startDebateBtn" class="send-btn">í† ë¡  ì‹œì‘</button>
                    <button id="recreateBtn" class="btn">í˜ë¥´ì†Œë‚˜ ì¬ìƒì„±</button>
                </div>
            `;
            chatContainer.appendChild(setupContainer);

            // 3. ìš”ì†Œ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            const topicInput = document.getElementById('topicInput');
            const generateBtn = document.getElementById('generatePersonasBtn');
            const recreateBtn = document.getElementById('recreateBtn');
            const startBtn = document.getElementById('startDebateBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const personasContainer = document.getElementById('personasContainer');
            const debateActions = document.getElementById('debateActions');
            const persona1Text = document.getElementById('persona1Text');
            const persona2Text = document.getElementById('persona2Text');

            generateBtn.addEventListener('click', fetchPersonas);
            recreateBtn.addEventListener('click', fetchPersonas);
            startBtn.addEventListener('click', startDebate);

            async function fetchPersonas() {
                const topic = topicInput.value.trim();
                if (!topic) {
                    alert('í† ë¡  ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                loadingSpinner.style.display = 'block';
                personasContainer.style.display = 'none';
                debateActions.style.display = 'none';
                generateBtn.disabled = true;

                try {
                    const response = await fetch('/api/generate-personas', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ topic: topic })
                    });
                    const data = await response.json();

                    if (data.error) {
                        alert(`ì˜¤ë¥˜: ${data.error}`);
                        return;
                    }

                    persona1Text.value = data.persona1;
                    persona2Text.value = data.persona2;

                    personasContainer.style.display = 'grid';
                    debateActions.style.display = 'flex';

                } catch (err) {
                    alert(`í˜ë¥´ì†Œë‚˜ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}`);
                } finally {
                    loadingSpinner.style.display = 'none';
                    generateBtn.disabled = false;
                }
            }

            async function startDebate() {
                const topic = topicInput.value.trim();
                const persona1 = persona1Text.value.trim();
                const persona2 = persona2Text.value.trim();

                if (!topic || !persona1 || !persona2) {
                    alert('ì£¼ì œì™€ ë‘ í˜ë¥´ì†Œë‚˜ ëª¨ë‘ ë‚´ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                startBtn.disabled = true;
                recreateBtn.disabled = true;

                try {
                    // 1. í† ë¡  ì„¤ì • ì„œë²„ì— ì „ì†¡
                    await fetch('/api/prepare-debate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ topic, persona1, persona2 })
                    });

                    // 2. UI ì „í™˜
                    setupContainer.style.display = 'none';
                    originalChatMessages.style.display = 'block';
                    originalChatMessages.innerHTML = '<div class="message bot-message"><div class="message-bubble">ì ì‹œ í›„ í† ë¡ ì´ ì‹œì‘ë©ë‹ˆë‹¤...</div></div>';

                    // 3. ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘
                    eventSource = new EventSource('/api/debate-stream');
                    let isFirstMessage = true;

                    eventSource.onmessage = function(event) {
                        if (isFirstMessage) {
                            originalChatMessages.innerHTML = '';
                            isFirstMessage = false;
                        }
                        originalChatMessages.innerHTML += event.data;
                        originalChatMessages.scrollTop = originalChatMessages.scrollHeight;
                    };

                    eventSource.onerror = function(err) {
                        originalChatMessages.innerHTML += "<p style='color: red; padding: 10px;'>ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>";
                        eventSource.close();
                    };

                } catch (err) {
                    alert(`í† ë¡  ì‹œì‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`);
                    startBtn.disabled = false;
                    recreateBtn.disabled = false;
                }
            }

            // ê¸°ì¡´ ëŒ€í™” ì´ˆê¸°í™” í•¨ìˆ˜ ì˜¤ë²„ë¼ì´ë“œ
            window.resetChat = function() {
                if (confirm("ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    if (eventSource) eventSource.close();
                    fetch('/api/reset/debate', { method: 'POST' }).finally(() => location.reload());
                }
            }
        }
      });
    </script>
  </body>
</html>
